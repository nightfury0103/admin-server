function _ImportExport(){function bind(){$('a[data-toggle="tab"]').unbind().on("show",(function(e){$(e.target.hash).trigger("show")})),$("#import-json-btn").unbind().click((function(){$(this).prop("disabled",!0),function importTextArea(e){MyWallet.getMainPassword((function(t){MyWallet.getSecondPassword((function(r){ImportExport.importJSON(e.val(),{main_password:t,second_password:r},(function(){MyWallet.backupWallet("update",(function(){MyWallet.get_history()}))}),(function(e){MyWallet.makeNotice("error","misc-error",e)}))}))}))}($("#import-json")),$(this).prop("disabled",!1)})),$("#import-address-btn").unbind().click((function(){var e=$.trim($("#import-address-address").val());if(e.length=0)MyWallet.makeNotice("error","misc-error","You must enter an address to import");else try{var t=new Bitcoin.Address(e);if(t.toString()!=e)throw"Inconsistency between addresses";$("#import-address-address").val(""),function showWatchOnlyWarning(e,t){var r=$("#watch-only-modal");r.modal({keyboard:!0,backdrop:"static",show:!0}),r.center(),r.find(".address").text(e),r.find(".btn.btn-secondary").unbind().click((function(){r.modal("hide")})),r.find(".btn.btn-primary").unbind().click((function(){t(),r.modal("hide")}))}(e,(function(){try{if(!MyWallet.addWatchOnlyAddress(e))throw"Wallet Full Or Addresses Exists";MyWallet.makeNotice("success","added-address","Successfully Added Address "+t);try{ws.send('{"op":"addr_sub", "addr":"'+t+'"}')}catch(e){}MyWallet.backupWallet("update",(function(){MyWallet.get_history()}))}catch(e){MyWallet.makeNotice("error","misc-error",e)}}))}catch(e){return void MyWallet.makeNotice("error","misc-error","Error importing address: "+e)}})),$("#import-private-scan").unbind().click((function(){MyWallet.getSecondPassword((function(){loadScript("wallet-legacy/signer",(function(){showPrivateKeyModal((function(e,t){if(!MyWallet.addPrivateKey(e,{compressed:t,app_name:IMPORTED_APP_NAME,app_version:IMPORTED_APP_VERSION}))throw"Unable to add private key for bitcoin address "+e.getBitcoinAddress();MyWallet.backupWallet("update",(function(){MyWallet.get_history()})),MyWallet.makeNotice("success","added-address","Imported Bitcoin Address "+e.getBitcoinAddress())}),(function(e){MyWallet.makeNotice("error","misc-error",e)}),"Any Private Key")}))}))})),$("#import-private-btn").unbind().click((function(){var e=$("#import-private-key");try{!function importPrivateKeyUI(e,t,r,o){MyWallet.getSecondPassword((function(){try{if(!e||0==e.length)throw"You must enter a private key to import";function reallyInsertKey(e,a){try{if(!MyWallet.addPrivateKey(e,{compressed:a,app_name:o||IMPORTED_APP_NAME,app_version:IMPORTED_APP_VERSION}))throw"Unable to add private key for bitcoin address "+i;var i=a?e.getBitcoinAddressCompressed().toString():e.getBitcoinAddress().toString();t&&t.length>0&&MyWallet.setAddressLabel(i,t),MyWallet.backupWallet("update",(function(){MyWallet.get_history()})),r&&r(),MyWallet.makeNotice("success","added","Added Bitcoin Address "+i)}catch(e){MyWallet.makeNotice("error","misc-error",e)}}var a=MyWallet.detectPrivateKeyFormat(e);if("bip38"==a)return void MyWallet.getPassword($("#import-private-key-password"),(function(t){ImportExport.parseBIP38toECKey(e,t,(function(e,t){reallyInsertKey(e,t)}),(function(e){MyWallet.makeNotice("error","misc-error",e)}))}));var i=MyWallet.privateKeyStringToKey(e,a),n=null;if(null==(n="compsipa"==a?i.getBitcoinAddressCompressed().toString():i.getBitcoinAddress().toString())||0==n.length||"undefined"==n)throw"Unable to decode bitcoin addresses from private key";if(MyWallet.addressExists(n)&&!MyWallet.isWatchOnly(n))throw"Address already exists in the wallet";function sweep(){loadScript("wallet-legacy/signer",(function(){BlockchainAPI.get_balance([n],(function(e){var t=initNewTx();t.fee=t.base_fee,t.to_addresses.push({address:new Bitcoin.Address(MyWallet.getPreferredAddress()),value:BigInteger.valueOf(e).subtract(t.fee)}),t.from_addresses=[n],t.extra_private_keys[n]=B58.encode(i.priv),t.start()}),(function(){MyWallet.makeNotice("error","misc-error","Error Getting Address Balance")}))}))}!function showPrivateKeyWarningModal(e,t,r){var o=$("#import-private-key-warning-modal");o.modal({keyboard:!0,backdrop:"static",show:!0}),o.center(),o.find(".address").text(e),BlockchainAPI.get_balance([e],(function(t){o.find(".address").text(e+" - "+formatBTC(t))}),(function(e){MyWallet.makeNotice("error","misc-error",e)})),o.find(".btn.btn-secondary").unbind().click((function(){t(),o.modal("hide")})),o.find(".btn.btn-primary").unbind().click((function(){r(),o.modal("hide")}))}(n,(function(){"compsipa"==a?function showCompressedPrivateKeyWarning(e,t){var r=$("#compressed-private-key-modal");r.modal({keyboard:!0,backdrop:"static",show:!0}),r.center(),r.find(".btn.btn-secondary").unbind().click((function(){e(),r.modal("hide")})),r.find(".btn.btn-primary").unbind().click((function(){t(),r.modal("hide")}))}((function(){reallyInsertKey(i,!0)}),(function(){sweep()})):reallyInsertKey(i,!1)}),(function(){sweep()}))}catch(e){MyWallet.makeNotice("error","misc-error","Error importing private key: "+e)}}))}($.trim(e.val()))}catch(e){MyWallet.makeNotice("error","misc-error","Error importing private key: "+e)}e.val("")})),$("#export-priv-format").change((function(e){$("#json-unencrypted-export").val(MyWallet.makeWalletJSON($("#export-priv-format").val()))})),$("#export-crypted").on("show",(function(){$("#json-crypted-export").val(MyWallet.getEncryptedWalletData())})),$("#export-unencrypted").on("show",(function(){MyWallet.getSecondPassword((function(){$("#export-priv-format").val("base58"),$("#json-unencrypted-export").val(MyWallet.makeWalletJSON($("#export-priv-format").val()))}))})),$("#import-backup").on("show",(function(){!function loadBackupsList(e){MyWallet.setLoadingText("Loading Backup List"),MyWallet.securePost("wallet",{method:"list-backups",format:"json"},(function(t){try{if(null==t)throw"Failed to get backups";var r=e.find("table tbody").empty(),o=t.results;if(0==o.length)throw"No backups found";for(var a in o){var i=o[a],n=$("<tr><td>"+i.name+"</td><td>"+dateToString(new Date(i.last_modified))+"</td><td>"+i.size+'</td><td><a class="act-import">Import</a></td></tr>');!function(e){n.find(".act-import").click((function(){importS3WalletBackup(e.id)}))}(i),r.append(n)}}catch(e){MyWallet.makeNotice("error","misc-error",e)}}),(function(e){MyWallet.makeNotice("error","misc-error",e.responseText)}))}($(this))})),$(".paper-wallet-btn").unbind().click((function(){loadScript("wallet-legacy/paper-wallet",(function(){PaperWallet.showModal()}))}))}function importS3WalletBackup(e){MyWallet.setLoadingText("Importing Backup"),MyWallet.securePost("wallet",{method:"get-backup",id:e,format:"json"},(function(e){try{var t=e.payload;MyWallet.getMainPassword((function(e){MyWallet.getSecondPassword((function(r){ImportExport.importJSON(t,{main_password:e,second_password:r},(function(){MyWallet.backupWallet("update",(function(){MyWallet.get_history()}))}),(function(e){MyWallet.makeNotice("error","misc-error",e)}))}))}))}catch(e){MyWallet.makeNotice("error","misc-error",e)}}),(function(e){MyWallet.makeNotice("error","misc-error",e.responseText)}))}this.init=function(e,t,r){if(MyWallet.setLoadingText("Loading Import Export View"),!e.is(":empty"))return bind(),void t();$.ajax({type:"GET",url:root+"wallet/import-export-template",timeout:6e4,data:{format:"plain",language:MyWallet.getLanguage()},success:function(o){try{e.html(o),bind(),t()}catch(e){console.log(e),r()}},error:function(){MyWallet.makeNotice("error","misc-error","Error Downloading Import Export Template"),r()}})},this.importJSON=function(e,t,r,o){try{var a=0;if(null==e||0==e.length)throw"No import data provided!";var i=null;try{if(null==(i=$.parseJSON(e)))throw"null input_text";if(i.payload)throw"version 2 wallet"}catch(a){return void MyWallet.decryptWallet(e,t.main_password,(function(e,a){ImportExport.importJSON(JSON.stringify(e),t,r,o)}),o)}var n=0,really_import=function(){try{var s=i.keys[n],l=s.addr;if(null!=l&&l.length>0&&"undefined"!=l)try{var c=s.priv;if(c||(c=s.sec),null!=c){var d=10;if(i.options&&i.options.pbkdf2_iterations&&(d=i.options.pbkdf2_iterations),i.double_encryption){if(!t.second_password)return void MyWallet.getPassword($("#import-second-password-modal"),(function(a){t.second_password=a,ImportExport.importJSON(e,t,r,o)}));var y=MyWallet.decrypt(c,i.sharedKey+t.second_password,d,MyWallet.isBase58);if(null==y)throw"Error decrypting private key for address "+l;c=y}var p=MyWallet.detectPrivateKeyFormat(c),f=MyWallet.privateKeyStringToKey(c,p);if(f.getBitcoinAddress().toString()!=l&&f.getBitcoinAddressCompressed().toString()!=l)throw"Not importing "+l+" because it is inconsistent with the decoded address ";try{MyWallet.addPrivateKey(f,{compressed:"compsipa"==p,app_name:i.created_device_name?i.created_device_name:IMPORTED_APP_NAME,app_version:i.created_device_version?i.created_device_version:IMPORTED_APP_VERSION,created_time:i.created_time?i.created_time:0})}catch(e){}++a}MyWallet.addressExists(l)&&(s.label&&$.trim(s.label.length)>0&&MyWallet.setAddressLabel(l,$.trim(s.label)),s.tag?MyWallet.setAddressTag(l,s.tag):MyWallet.setAddressTag(l,1))}catch(e){console.log(e)}if(n<i.keys.length-1)return++n,void setTimeout(really_import,10);if(null!=i.address_book)for(var u=0;u<i.address_book.length;++u){var m=i.address_book[u];m.addr&&m.label&&MyWallet.addAddressBookEntry(m.addr,m.label)}if($("#import-input_text").val(""),!(a>0))throw"No Private Keys Imported. Unknown Format Incorrect Password";r()}catch(e){console.log(e);try{o(e)}catch(e){}}};if(null==i){if(a=function parsePrivateKeysFromText(e){var t=e.split(/\W+/g);try{var r=0;for(var o in t){var a=t[o];try{var i=MyWallet.detectPrivateKeyFormat(a),n=MyWallet.privateKeyStringToKey(a,i),s="compsipa"==i;try{MyWallet.addPrivateKey(n,{compressed:s,app_name:IMPORTED_APP_NAME,app_version:IMPORTED_APP_VERSION})}catch(e){}++r}catch(e){}}return r}catch(e){MyWallet.makeNotice("error","misc-error",e)}return!1}(e),$("#import-input_text").val(""),!(a>0))throw"No Private Keys Imported. Unknown Format or Incorrect Password";r()}else{if(!(null!=i&&null!=i.keys&&i.keys.length>0))throw"Unknown Format";if(i.keys.length>500){MyWallet.makeNotice("info","keys-skipped","Some keys may have been skipped");var s=0,l=[],c=i.keys.slice(0),do_part=function(){try{for(;s<c.length;++s){var e=c[s],t=e.addr;if(null!=t&&0!=t.length&&"undefined"!=t&&(l.push(e.addr),500==l.length||s==i.keys.length-1&&l.length>0))return BlockchainAPI.get_balances(l,(function(e){try{for(var t in e)if(0==e[t].final_balance)for(var r=0;r<i.keys.length;++r){i.keys[r].addr==t&&i.keys.length>1&&i.keys.splice(r,1)}}catch(e){console.log(e);try{o(e)}catch(e){}}}),(function(e){console.log(e);try{o(e)}catch(e){}})),l=[],void(s==i.keys.length-1?really_import():setTimeout(do_part,100))}}catch(e){console.log(e);try{o(e)}catch(e){}}};do_part()}else really_import()}}catch(e){console.log(e);try{o(e)}catch(e){}}},this.parseBIP38toECKey=function(e,t,r,o){var a;try{a=Bitcoin.Base58.decode(e)}catch(e){return void o("Invalid Private Key")}if(43==a.length)if(1==a[0]){var i=a.slice(-4);a=a.slice(0,-4);var n=Crypto.SHA256(Crypto.SHA256(a,{asBytes:!0}),{asBytes:!0});if(n[0]==i[0]&&n[1]==i[1]&&n[2]==i[2]&&n[3]==i[3]){var s,l=!1,c=!1,d=!1;if(66==a[1]){if(224==a[2])l=!0;else if(192!=a[2])return void o("Invalid Private Key")}else{if(67!=a[1])return void o("Invalid Private Key");if(c=!0,l=0!=(32&a[2]),d=0!=(4&a[2]),(36&a[2])!=a[2])return void o("Invalid Private Key")}var y={mode:new Crypto.mode.ECB(Crypto.pad.NoPadding),asBytes:!0},verifyHashAndReturn=function(){var e=new Bitcoin.ECKey(s),t=l?e.getBitcoinAddressCompressed():e.getBitcoinAddress();(n=Crypto.SHA256(Crypto.SHA256(t.toString(),{asBytes:!0}),{asBytes:!0}))[0]==a[3]&&n[1]==a[4]&&n[2]==a[5]&&n[3]==a[6]?r(e,l):o("Incorrect Passphrase")};if(c){var p=a.slice(7,15),f=d?p.slice(0,4):p;ImportExport.Crypto_scrypt(t,f,16384,8,8,32,(function(e){var t;if(d){var r=e.concat(p);t=Crypto.SHA256(Crypto.SHA256(r,{asBytes:!0}),{asBytes:!0})}else t=e;var o=new Bitcoin.ECKey(t).getPubCompressed(),i=a.slice(23,39),n=a.slice(3,15);ImportExport.Crypto_scrypt(o,n,1024,1,1,64,(function(e){for(var r=e.slice(32),o=Crypto.AES.decrypt(i,r,y),n=0;n<16;n++)o[n]^=e[n+16];var l=a.slice(15,23).concat(o.slice(0,8)),c=Crypto.AES.decrypt(l,r,y);for(n=0;n<16;n++)c[n]^=e[n];var d=c.slice(0,16).concat(o.slice(8,16)),p=Crypto.SHA256(Crypto.SHA256(d,{asBytes:!0}),{asBytes:!0}),f=secp256k1(),u=BigInteger.fromByteArrayUnsigned(t).multiply(BigInteger.fromByteArrayUnsigned(p)).remainder(f.getN());s=u.toByteArrayUnsigned(),verifyHashAndReturn()}))}))}else{var u=a.slice(3,7);ImportExport.Crypto_scrypt(t,u,16384,8,8,64,(function(e){var t=e.slice(32,64);s=Crypto.AES.decrypt(a.slice(7,39),t,y);for(var r=0;r<32;r++)s[r]^=e[r];verifyHashAndReturn()}))}}else o("Invalid Private Key")}else o("Invalid Private Key");else o("Invalid Private Key")};var e=2147483647,t=null;this.Crypto_scrypt=function(r,o,a,i,n,s,l){if(0==a||0!=(a&a-1))throw Error("N must be > 0 and a power of 2");if(a>e/128/i)throw Error("Parameter N is too large");if(i>e/128/n)throw Error("Parameter r is too large");var c={iterations:1,hasher:Crypto.SHA256,asBytes:!0},d=Crypto.PBKDF2(r,o,128*n*i,c);try{var y=0,p=0,f=[function(){if(!t){var e,o="("+scryptCore.toString()+")()";try{e=new Blob([o],{type:"text/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,(e=new BlobBuilder).append(o),e=e.getBlob("text/javascript")}t=URL.createObjectURL(e)}var f=new Worker(t);return f.onmessage=function(e){var t=e.data[0],o=e.data[1];p++,y<n&&f.postMessage([a,i,n,d,y++]);for(var u=o.length,m=128*t*i,v=0;u--;)d[m++]=o[v++];p==n&&l(Crypto.PBKDF2(r,d,s,c))},f}()];f[0].postMessage([a,i,n,d,y++]),n>1&&f[1].postMessage([a,i,n,d,y++])}catch(e){window.setTimeout((function(){scryptCore(),l(Crypto.PBKDF2(r,d,s,c))}),0)}function scryptCore(){var e=[],t=[];if(void 0===d)onmessage=function(r){var o=r.data,a=o[0],i=o[1],n=(o[2],o[3]),s=o[4],l=[];arraycopy32(n,128*s*i,l,0,128*i),smix(l,0,i,a,t,e),postMessage([s,l])};else for(var r=0;r<n;r++)smix(d,128*r*i,i,a,t,e);function smix(e,t,r,o,a,i){var n,s=128*r;for(arraycopy32(e,t,i,0,s),n=0;n<o;n++)arraycopy32(i,0,a,n*s,s),blockmix_salsa8(i,0,s,r);for(n=0;n<o;n++){blockxor(a,(integerify(i,0,r)&o-1)*s,i,0,s),blockmix_salsa8(i,0,s,r)}arraycopy32(i,0,e,t,s)}function blockmix_salsa8(e,t,r,o){var a,i=[];for(arraycopy32(e,t+64*(2*o-1),i,0,64),a=0;a<2*o;a++)blockxor(e,64*a,i,0,64),salsa20_8(i),arraycopy32(i,0,e,r+64*a,64);for(a=0;a<o;a++)arraycopy32(e,r+2*a*64,e,t+64*a,64);for(a=0;a<o;a++)arraycopy32(e,r+64*(2*a+1),e,t+64*(a+o),64)}function R(e,t){return e<<t|e>>>32-t}function salsa20_8(e){var t,r=new Array(32),o=new Array(32);for(t=0;t<16;t++)r[t]=(255&e[4*t+0])<<0,r[t]|=(255&e[4*t+1])<<8,r[t]|=(255&e[4*t+2])<<16,r[t]|=(255&e[4*t+3])<<24;for(function arraycopy(e,t,r,o,a){for(;a--;)r[o++]=e[t++]}(r,0,o,0,16),t=8;t>0;t-=2)o[4]^=R(o[0]+o[12],7),o[8]^=R(o[4]+o[0],9),o[12]^=R(o[8]+o[4],13),o[0]^=R(o[12]+o[8],18),o[9]^=R(o[5]+o[1],7),o[13]^=R(o[9]+o[5],9),o[1]^=R(o[13]+o[9],13),o[5]^=R(o[1]+o[13],18),o[14]^=R(o[10]+o[6],7),o[2]^=R(o[14]+o[10],9),o[6]^=R(o[2]+o[14],13),o[10]^=R(o[6]+o[2],18),o[3]^=R(o[15]+o[11],7),o[7]^=R(o[3]+o[15],9),o[11]^=R(o[7]+o[3],13),o[15]^=R(o[11]+o[7],18),o[1]^=R(o[0]+o[3],7),o[2]^=R(o[1]+o[0],9),o[3]^=R(o[2]+o[1],13),o[0]^=R(o[3]+o[2],18),o[6]^=R(o[5]+o[4],7),o[7]^=R(o[6]+o[5],9),o[4]^=R(o[7]+o[6],13),o[5]^=R(o[4]+o[7],18),o[11]^=R(o[10]+o[9],7),o[8]^=R(o[11]+o[10],9),o[9]^=R(o[8]+o[11],13),o[10]^=R(o[9]+o[8],18),o[12]^=R(o[15]+o[14],7),o[13]^=R(o[12]+o[15],9),o[14]^=R(o[13]+o[12],13),o[15]^=R(o[14]+o[13],18);for(t=0;t<16;++t)r[t]=o[t]+r[t];for(t=0;t<16;t++){var a=4*t;e[a+0]=r[t]>>0&255,e[a+1]=r[t]>>8&255,e[a+2]=r[t]>>16&255,e[a+3]=r[t]>>24&255}}function blockxor(e,t,r,o,a){for(var i=a>>6;i--;)r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++],r[o++]^=e[t++]}function integerify(e,t,r){var o;return o=(255&e[(t+=64*(2*r-1))+0])<<0,o|=(255&e[t+1])<<8,o|=(255&e[t+2])<<16,o|=(255&e[t+3])<<24}function arraycopy32(e,t,r,o,a){for(var i=a>>5;i--;)r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++],r[o++]=e[t++]}}}}var ImportExport=new _ImportExport;