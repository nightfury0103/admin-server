var BlockchainAPI=new function(){var t,n=this,r=6e4;(t=jQuery).retryAjax=function(n){var r;n.tryCount=n.tryCount?n.tryCount:0,n.retryLimit=n.retryLimit?n.retryLimit:2,n.suppressErrors=!0,n.error?(r=n.error,delete n.error):r=function(){},n.complete=function(n,o){if(t.inArray(o,["timeout","abort","error"])>-1)return this.tryCount++,!(this.tryCount<=this.retryLimit&&(this.tryCount===this.retryLimit&&(this.error=r,delete this.suppressErrors),t.ajax(this),0))},t.ajax(n)},this.get_history=function(t,n,o,a,s){MyWallet.setLoadingText("Loading transactions");var l=(new Date).getTime();o||(o=6),a||(a=0),s||(s=0);var c={active:MyWallet.getActiveAddresses().join("|"),format:"json",filter:o,offset:a,no_compact:!0,ct:l,n:s,language:MyWallet.getLanguage(),symbol_btc:symbol_btc.code,symbol_local:symbol_local.code};$.retryAjax({type:"POST",dataType:"json",url:root+"multiaddr",data:c,timeout:r,success:function(r){null!=r.error&&MyWallet.makeNotice("error","misc-error",r.error),MyWallet.handleNTPResponse(r,l);try{0==a&&0==o&&MyStore.put("multiaddr",JSON.stringify(r)),t(r)}catch(t){MyWallet.makeNotice("error","misc-error",t),n()}},error:function(t){t.responseText?MyWallet.makeNotice("error","misc-error",t.responseText):MyWallet.makeNotice("error","misc-error","Error Downloading Wallet Balance"),n()}})},this.get_balances=function(t,n,o){MyWallet.setLoadingText("Getting Balances"),$.ajax({type:"POST",url:root+"multiaddr",dataType:"json",timeout:r,data:{active:t.join("|"),simple:!0,format:"json"},success:function(t){for(var r in t)MyWallet.addressExists(r)&&MyWallet.setAddressBalance(r,t[r].final_balance);n(t)},error:function(t){o(t.responseText)}})},this.get_balance=function(t,n,r){MyWallet.setLoadingText("Getting Balance"),this.get_balances(t,(function(t){var r=0;for(var o in t)r+=t[o].final_balance;n(r)}),r)},this.get_ticker=function(){MyWallet.setLoadingText("Getting Ticker Data"),$.ajax({type:"GET",dataType:"json",url:root+"ticker",data:{format:"json"},timeout:r,success:function(t){var n=$("#send-ticker ul").empty();for(var r in t){var o=$('<li><div style="width:35px;padding-left:10px;font-weight:bold;display:inline-block" class="code"></div>  <i class="icon-user" style="background-image:url('+resource+(t[r]["15m"]>=t[r]["24h"]?"up_green.png":"down_red.png")+');width:14px;background-position:0px"></i><span class="value"></span></li>');o.find(".code").text(r),o.find(".value").text(t[r]["15m"]),n.append(o)}},error:function(t){console.log(t)}})},this.resolve_firstbits=function(t,n,o){MyWallet.setLoadingText("Querying Firstbits"),$.ajax({type:"GET",url:root+"q/resolvefirstbits/"+t,data:{format:"plain"},timeout:r,success:function(t){null==t||0==t.length?o():n(t)},error:function(t){o(t.responseText)}})},this.get_rejection_reason=function(t,n,o,a){MyWallet.setLoadingText("Querying Rejection Reason"),$.ajax({type:"GET",url:root+"q/rejected/"+t,data:{format:"plain"},timeout:r,success:function(t){null==t||0==t.length?a():"Transaction Not Rejected"==t?o():n(t)},error:function(t){a(t.responseText)}})},this.push_tx=function(t,o,a,s){try{var g=function(t){f&&(clearInterval(f),f=null),s&&(s(t),s=null)};MyWallet.setLoadingText("Pushing Transaction");var l=MyWallet.getTransactions();if(l.length>0)var c=l[0].txIndex;var u=t.serialize(),y=Crypto.util.bytesToHex(Crypto.SHA256(Crypto.SHA256(u,{asBytes:!0}),{asBytes:!0}).reverse()),i=function(){!function(t){f&&(clearInterval(f),f=null),a&&(a(t),a=null)}(),setTimeout((function(){0!=l.length&&l[0].txIndex!=c||function e(){MyWallet.get_history((function(){0==l.length||l[0].txIndex==c?n.get_rejection_reason(y,(function(t){MyWallet.makeNotice("error","tx-error",t)}),(function(){0!=l.length&&l[0].txIndex!=c||MyWallet.get_history()}),(function(){0!=l.length&&l[0].txIndex!=c||MyWallet.makeNotice("error","tx-error","Unknown Error Pushing Transaction")})):playSound("beep")}),(function(){MyWallet.makeNotice("error","tx-error","Unable to determine if transaction was submitted. Please re-login.")}))}()}),3e3)},f=setInterval((function(){n.get_rejection_reason(y,(function(t){console.log(t)}),(function(){i&&(i(),i=null),clearInterval(f),f=null}),(function(t){console.log(t)}))}),5e3);function v(){var t={format:"plain",tx:Crypto.util.bytesToHex(u),hash:y};o&&(t.note=o),$.ajax({type:"POST",url:root+"pushtx",timeout:r,data:t,success:function(){i&&(i(),i=null)},error:function(t){g(t?t.responseText:null)}})}try{var p=new ArrayBuffer(u.length);new Int8Array(p).set(u);var d=new Blob([p],{type:"application/octet-stream"});if(d.size!=u.length)throw"Inconsistent Data Sizes (blob : "+d.size+" s : "+u.length+" buffer : "+p.byteLength+")";var m=new FormData;m.append("txbytes",d),o&&m.append("note",o),m.append("format","plain"),m.append("hash",y),$.ajax({url:root+"pushtx",data:m,processData:!1,contentType:!1,timeout:r,type:"POST",success:function(){i&&(i(),i=null)},error:function(t){t.responseText&&0!=t.responseText.indexOf("Parse:")?g(t?t.responseText:null):setTimeout((function(){v()}),2e3)}})}catch(t){console.log(t),v()}}catch(t){console.log(t),g(t)}},this.get_unspent=function(t,n,o,a,s){MyWallet.setLoadingText("Getting Unspent Outputs"),$.retryAjax({type:"POST",dataType:"json",url:root+"unspent",timeout:r,data:{active:t.join("|"),format:"json",confirmations:a||0},success:function(t){try{if(null!=t.error)throw t.error;null!=t.notice&&MyWallet.makeNotice("notice","misc-notice",t.notice),n&&n(t)}catch(t){o&&o(t)}},error:function(t){o&&o(t.responseText)}})}};