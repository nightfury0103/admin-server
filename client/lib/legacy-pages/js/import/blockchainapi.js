var BlockchainAPI=new function(){var t=this,e=6e4;!function(t){t.retryAjax=function(e){var n;e.tryCount=e.tryCount?e.tryCount:0,e.retryLimit=e.retryLimit?e.retryLimit:2,e.suppressErrors=!0,e.error?(n=e.error,delete e.error):n=function(){},e.complete=function(e,r){if(t.inArray(r,["timeout","abort","error"])>-1)return this.tryCount++,!(this.tryCount<=this.retryLimit)||(this.tryCount===this.retryLimit&&(this.error=n,delete this.suppressErrors),t.ajax(this),!0)},t.ajax(e)}}(jQuery),this.get_history=function(t,n,r,o,a){MyWallet.setLoadingText("Loading transactions");var i=(new Date).getTime();r||(r=6),o||(o=0),a||(a=0);var s={active:MyWallet.getActiveAddresses().join("|"),format:"json",filter:r,offset:o,no_compact:!0,ct:i,n:a,language:MyWallet.getLanguage(),symbol_btc:symbol_btc.code,symbol_local:symbol_local.code};$.retryAjax({type:"POST",dataType:"json",url:root+"multiaddr",data:s,timeout:e,success:function(e){null!=e.error&&MyWallet.makeNotice("error","misc-error",e.error),MyWallet.handleNTPResponse(e,i);try{0==o&&0==r&&MyStore.put("multiaddr",JSON.stringify(e)),t(e)}catch(t){MyWallet.makeNotice("error","misc-error",t),n()}},error:function(t){t.responseText?MyWallet.makeNotice("error","misc-error",t.responseText):MyWallet.makeNotice("error","misc-error","Error Downloading Wallet Balance"),n()}})},this.get_balances=function(t,n,r){MyWallet.setLoadingText("Getting Balances"),$.ajax({type:"POST",url:root+"multiaddr",dataType:"json",timeout:e,data:{active:t.join("|"),simple:!0,format:"json"},success:function(t){for(var e in t)MyWallet.addressExists(e)&&MyWallet.setAddressBalance(e,t[e].final_balance);n(t)},error:function(t){r(t.responseText)}})},this.get_balance=function(t,e,n){MyWallet.setLoadingText("Getting Balance"),this.get_balances(t,(function(t){var n=0;for(var r in t)n+=t[r].final_balance;e(n)}),n)},this.get_ticker=function(){MyWallet.setLoadingText("Getting Ticker Data"),$.ajax({type:"GET",dataType:"json",url:root+"ticker",data:{format:"json"},timeout:e,success:function(t){var e=$("#send-ticker ul").empty();for(var n in t){var r=$('<li><div style="width:35px;padding-left:10px;font-weight:bold;display:inline-block" class="code"></div>  <i class="icon-user" style="background-image:url('+resource+(t[n]["15m"]>=t[n]["24h"]?"up_green.png":"down_red.png")+');width:14px;background-position:0px"></i><span class="value"></span></li>');r.find(".code").text(n),r.find(".value").text(t[n]["15m"]),e.append(r)}},error:function(t){console.log(t)}})},this.resolve_firstbits=function(t,n,r){MyWallet.setLoadingText("Querying Firstbits"),$.ajax({type:"GET",url:root+"q/resolvefirstbits/"+t,data:{format:"plain"},timeout:e,success:function(t){null==t||0==t.length?r():n(t)},error:function(t){r(t.responseText)}})},this.get_rejection_reason=function(t,n,r,o){MyWallet.setLoadingText("Querying Rejection Reason"),$.ajax({type:"GET",url:root+"q/rejected/"+t,data:{format:"plain"},timeout:e,success:function(t){null==t||0==t.length?o():"Transaction Not Rejected"==t?r():n(t)},error:function(t){o(t.responseText)}})},this.push_tx=function(n,r,o,a){try{var _error=function(t){u&&(clearInterval(u),u=null),a&&(a(t),a=null)};MyWallet.setLoadingText("Pushing Transaction");var i=MyWallet.getTransactions();if(i.length>0)var s=i[0].txIndex;var l=n.serialize(),c=Crypto.util.bytesToHex(Crypto.SHA256(Crypto.SHA256(l,{asBytes:!0}),{asBytes:!0}).reverse()),did_push=function(){var e;u&&(clearInterval(u),u=null),o&&(o(e),o=null),setTimeout((function(){0!=i.length&&i[0].txIndex!=s||function call_history(){MyWallet.get_history((function(){0==i.length||i[0].txIndex==s?t.get_rejection_reason(c,(function(t){MyWallet.makeNotice("error","tx-error",t)}),(function(){0!=i.length&&i[0].txIndex!=s||MyWallet.get_history()}),(function(){0!=i.length&&i[0].txIndex!=s||MyWallet.makeNotice("error","tx-error","Unknown Error Pushing Transaction")})):playSound("beep")}),(function(){MyWallet.makeNotice("error","tx-error","Unable to determine if transaction was submitted. Please re-login.")}))}()}),3e3)},u=setInterval((function(){t.get_rejection_reason(c,(function(t){console.log(t)}),(function(){did_push&&(did_push(),did_push=null),clearInterval(u),u=null}),(function(t){console.log(t)}))}),5e3);function push_normal(){var t={format:"plain",tx:Crypto.util.bytesToHex(l),hash:c};r&&(t.note=r),$.ajax({type:"POST",url:root+"pushtx",timeout:e,data:t,success:function(){did_push&&(did_push(),did_push=null)},error:function(t){_error(t?t.responseText:null)}})}try{var y=new ArrayBuffer(l.length);new Int8Array(y).set(l);var f=new Blob([y],{type:"application/octet-stream"});if(f.size!=l.length)throw"Inconsistent Data Sizes (blob : "+f.size+" s : "+l.length+" buffer : "+y.byteLength+")";var p=new FormData;p.append("txbytes",f),r&&p.append("note",r),p.append("format","plain"),p.append("hash",c),$.ajax({url:root+"pushtx",data:p,processData:!1,contentType:!1,timeout:e,type:"POST",success:function(){did_push&&(did_push(),did_push=null)},error:function(t){t.responseText&&0!=t.responseText.indexOf("Parse:")?_error(t?t.responseText:null):setTimeout((function(){push_normal()}),2e3)}})}catch(t){console.log(t),push_normal()}}catch(t){console.log(t),_error(t)}},this.get_unspent=function(t,n,r,o,a){MyWallet.setLoadingText("Getting Unspent Outputs"),$.retryAjax({type:"POST",dataType:"json",url:root+"unspent",timeout:e,data:{active:t.join("|"),format:"json",confirmations:o||0},success:function(t){try{if(null!=t.error)throw t.error;null!=t.notice&&MyWallet.makeNotice("notice","misc-notice",t.notice),n&&n(t)}catch(t){r&&r(t)}},error:function(t){r&&r(t.responseText)}})}};